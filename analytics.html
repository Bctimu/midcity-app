<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analytics</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Analytics Dashboard</h1>
  <div id="analytics"></div>

  <script>
    // Firebase config (replace with your own)
    const firebaseConfig = {
      apiKey: "...",
      authDomain: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Helper: get uid from URL query string ?uid=...
    function getUidFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('uid');
    }

    const uid = getUidFromUrl();

    if (!uid) {
      document.getElementById('analytics').innerText = "No UID provided in URL.";
      throw new Error("UID missing in URL");
    }

    // Query valid_tokens based on uid
    let tokensQuery;

    if (uid === "midcity") {
      // midcity user sees all data
      tokensQuery = db.collection('valid_tokens');
    } else {
      // others see only their tokens
      tokensQuery = db.collection('valid_tokens').where('userId', '==', uid);
    }

    tokensQuery.get()
      .then(snapshot => {
        const container = document.getElementById('analytics');
        if (snapshot.empty) {
          container.innerText = "No analytics data available.";
          return;
        }

        let html = '<ul>';
        snapshot.forEach(doc => {
          const data = doc.data();
          html += `<li>Token ID: ${doc.id} — User: ${data.userId} — Created: ${new Date(data.createdAt?.seconds * 1000).toLocaleString()}</li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
      })
      .catch(error => {
        console.error("Error loading analytics:", error);
        document.getElementById('analytics').innerText = "Error loading analytics data.";
      });
  </script>
</body>
</html>
