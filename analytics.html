<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - MidCity App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <style>
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Welcome to MidCity App</h1>

        <div id="role-selection" class="flex flex-col space-y-4">
            <button id="merchant-btn" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-md shadow-md transition-colors">
                Merchant Login
            </button>
            <button id="resident-btn" class="w-full py-3 px-6 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-md shadow-md transition-colors">
                Resident Login
            </button>
        </div>

        <form id="login-form" class="space-y-6 hidden">
            <h2 id="form-title" class="text-2xl font-bold text-center mb-4 text-gray-800"></h2>

            <div id="full-name-group" class="hidden">
                <label for="full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="full-name" name="full-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>

            <div id="business-name-group" class="hidden">
                <label for="business-name" class="block text-sm font-medium text-gray-700">Business Name</label>
                <input type="text" id="business-name" name="business-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>

            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email address</label>
                <input type="email" id="email" name="email" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" name="password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            
            <div>
                <button type="submit" id="submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    Sign In
                </button>
            </div>
        </form>

        <p id="error-message" class="mt-4 text-center text-sm text-red-600"></p>

        <div id="form-toggle" class="mt-6 text-center hidden">
            <button id="toggle-form-btn" class="text-sm font-medium text-blue-600 hover:text-blue-500">
                Don't have an account? Sign Up
            </button>
        </div>
        
        <div id="back-button-container" class="mt-6 text-center hidden">
             <button id="back-btn" class="text-sm font-medium text-gray-600 hover:text-gray-500">
                ‚Üê Back to role selection
            </button>
        </div>

        <!-- New post-login navigation for merchants/admins -->
        <div id="post-login-nav" class="hidden mt-6 text-center">
            <p class="text-lg font-semibold text-green-600 mb-4">Login Successful!</p>
            <div class="flex flex-col space-y-3">
                <a href="https://bctimu.github.io/midcity-app/scan.html" class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Go to Scanner</a>
                <a href="https://bctimu.github.io/midcity-app/analytics.html" class="py-2 px-4 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors">Go to Analytics</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const BASE_URL = "https://bctimu.github.io/midcity-app";

        const firebaseConfig = {
            apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
            authDomain: "admin-17c3d.firebaseapp.com",
            projectId: "admin-17c3d",
            storageBucket: "admin-17c3d.appspot.com",
            messagingSenderId: "456331474186",
            appId: "1:456331474186:web:0385a740d37862f82af6f3",
            measurementId: "G-DTP30VXLN7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const roleSelectionDiv = document.getElementById('role-selection');
        const loginForm = document.getElementById('login-form');
        const formTitle = document.getElementById('form-title');
        const merchantBtn = document.getElementById('merchant-btn');
        const residentBtn = document.getElementById('resident-btn');
        const backBtn = document.getElementById('back-btn');
        const formToggleDiv = document.getElementById('form-toggle');
        const backButtonContainer = document.getElementById('back-button-container');

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const fullNameInput = document.getElementById('full-name');
        const fullNameGroup = document.getElementById('full-name-group');
        const businessNameInput = document.getElementById('business-name');
        const businessNameGroup = document.getElementById('business-name-group');
        const submitBtn = document.getElementById('submit-btn');
        const toggleFormBtn = document.getElementById('toggle-form-btn');
        const errorMessage = document.getElementById('error-message');
        const postLoginNav = document.getElementById('post-login-nav');

        let isSignUpMode = false;
        let userRole = null;

        // Role selection
        merchantBtn.addEventListener('click', () => {
            userRole = 'merchant';
            showForm('Merchant Login');
        });

        residentBtn.addEventListener('click', () => {
            userRole = 'resident';
            showForm('Resident Login');
        });
        
        backBtn.addEventListener('click', () => {
            showRoleSelection();
        });

        function showForm(title) {
            roleSelectionDiv.classList.add('hidden');
            loginForm.classList.remove('hidden');
            formToggleDiv.classList.remove('hidden');
            backButtonContainer.classList.remove('hidden');
            formTitle.textContent = title;
            isSignUpMode = false;
            toggleFormBtn.textContent = "Don't have an account? Sign Up";
            submitBtn.textContent = "Sign In";

            // Hide all specific fields first
            businessNameGroup.classList.add('hidden');
            businessNameInput.required = false;
            fullNameGroup.classList.add('hidden');
            fullNameInput.required = false;
        }
        
        function showRoleSelection() {
             roleSelectionDiv.classList.remove('hidden');
             loginForm.classList.add('hidden');
             formToggleDiv.classList.add('hidden');
             backButtonContainer.classList.add('hidden');
             postLoginNav.classList.add('hidden'); // Ensure post-login nav is hidden
             userRole = null;
             emailInput.value = '';
             passwordInput.value = '';
             fullNameInput.value = '';
             businessNameInput.value = '';
             errorMessage.textContent = '';
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.textContent = '';
            
            const email = emailInput.value;
            const password = passwordInput.value;

            try {
                if (isSignUpMode) {
                    const businessName = userRole === 'merchant' ? businessNameInput.value : '';
                    const fullName = userRole === 'resident' ? fullNameInput.value : '';

                    if (userRole === 'merchant' && !businessName) {
                        errorMessage.textContent = 'Please enter a business name.';
                        return;
                    }

                    if (userRole === 'resident' && !fullName) {
                        errorMessage.textContent = 'Please enter your full name.';
                        return;
                    }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await setDoc(doc(db, "users", user.uid), {
                        email: user.email,
                        createdAt: new Date(),
                        fullName: fullName,
                        businessName: businessName,
                        isResident: userRole === 'resident',
                        role: userRole
                    });
                    console.log("User signed up and data saved to Firestore.");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("User signed in successfully.");
                }
            } catch (error) {
                let message = 'An unknown error occurred.';
                if (error.code === 'auth/email-already-in-use' && isSignUpMode) {
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        console.log("User signed in successfully after failed sign-up.");
                        return;
                    } catch (signInError) {
                        message = 'An account with this email already exists, but the password was incorrect.';
                        console.error(signInError);
                    }
                } else {
                    switch (error.code) {
                        case 'auth/invalid-email': message = 'Invalid email address.'; break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password': message = 'Invalid email or password.'; break;
                        case 'auth/email-already-in-use': message = 'An account with this email already exists.'; break;
                        case 'auth/weak-password': message = 'Password should be at least 6 characters.'; break;
                        case 'auth/operation-not-allowed': message = 'This authentication method is not enabled. Please check your Firebase project settings.'; break;
                        default: message = error.message; break;
                    }
                }
                errorMessage.textContent = message;
                console.error(error);
            }
        });

        toggleFormBtn.addEventListener('click', () => {
            isSignUpMode = !isSignUpMode;
            if (isSignUpMode) {
                formTitle.textContent = `${userRole.charAt(0).toUpperCase() + userRole.slice(1)} Sign Up`;
                submitBtn.textContent = 'Sign Up';
                toggleFormBtn.textContent = 'Already have an account? Sign In';

                if (userRole === 'merchant') {
                    businessNameGroup.classList.remove('hidden');
                    businessNameInput.required = true;
                    fullNameGroup.classList.add('hidden');
                    fullNameInput.required = false;
                } else if (userRole === 'resident') {
                    fullNameGroup.classList.remove('hidden');
                    fullNameInput.required = true;
                    businessNameGroup.classList.add('hidden');
                    businessNameInput.required = false;
                }
            } else {
                formTitle.textContent = `${userRole.charAt(0).toUpperCase() + userRole.slice(1)} Login`;
                submitBtn.textContent = 'Sign In';
                toggleFormBtn.textContent = "Don't have an account? Sign Up";

                businessNameGroup.classList.add('hidden');
                businessNameInput.required = false;
                fullNameGroup.classList.add('hidden');
                fullNameInput.required = false;
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.role === 'merchant' || userData.role === 'admin') {
                            // For merchants/admins, show post-login navigation
                            roleSelectionDiv.classList.add('hidden');
                            loginForm.classList.add('hidden');
                            formToggleDiv.classList.add('hidden');
                            backButtonContainer.classList.add('hidden');
                            postLoginNav.classList.remove('hidden');
                        } else if (userData.role === 'resident') {
                            // Residents redirect directly
                            window.location.href = `${BASE_URL}/index.html`;
                        }
                    } else {
                         // User exists in Auth but not in Firestore 'users' collection (shouldn't happen with new signup flow)
                         // Force them to re-select role or handle as error
                         showRoleSelection();
                    }
                } catch (error) {
                    console.error("Error fetching user role: ", error);
                    showRoleSelection(); // Fallback to role selection on error
                }
            } else {
                // If no user is logged in, show the role selection screen
                showRoleSelection();
            }
        });

    </script>
</body>
</html>
