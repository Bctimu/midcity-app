<!DOCTYPE html>
<html>
<head>
    <title>QR Code Scanner</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #212121; /* Light grey background */
            padding: 20px;
            box-sizing: border-box;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2.2em;
            text-align: center;
        }
        #reader-container {
            background-color: #ffffff;
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            width: 100%;
            max-width: 550px; /* Max width for larger screens */
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        #reader {
            width: 100%; /* Make reader responsive */
            min-height: 300px; /* Ensure a minimum height */
            border: 2px solid #e0e0e0;
            border-radius: 8px; /* Rounded corners for the reader area */
            overflow: hidden;
            background-color: #f8f9fa;
        }
        #result {
            margin-top: 25px;
            font-size: 1.3em;
            color: #34495e;
            font-weight: bold;
            text-align: center;
            word-break: break-all; /* Prevent long words from overflowing */
        }
        #cameraStatus {
            margin-top: 15px;
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: center;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center;
        }
        button {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px; /* Rounded corners */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-weight: 600;
        }
        #flipCameraButton {
            background-color: #3498db; /* Blue */
            color: white;
        }
        #flipCameraButton:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        #flipCameraButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }
            #reader-container {
                padding: 15px;
            }
            #reader {
                min-height: 250px;
            }
            button {
                width: 100%; /* Full width buttons on small screens */
                margin-top: 10px;
            }
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <h1>Scan Resident QR Code</h1>
    <div id="reader-container">
        <div id="reader"></div>
        <div class="controls">
            <button id="flipCameraButton">Flip Camera</button>
        </div>
        <div id="result"></div>
        <div id="cameraStatus">Initializing camera...</div>
    </div>

    <script type="text/javascript">
        // Global variables to manage the scanner state
        let html5QrcodeScanner = null;
        let currentCameraId = null;
        let availableCameras = [];
        let isScanning = false; // Flag to track if scanner is active


        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return; // Prevent processing if scanner is stopped
            console.log(`Code matched = ${decodedText}`, decodedResult);
            document.getElementById('result').innerText = `Scan result: ${decodedText}`;

        function onScanError(errorMessage) {

        async function startScanner(preferredCameraId = null) {
            // Stop any existing scanner instance if active
            if (html5QrcodeScanner && isScanning) {
                try {
                    await html5QrcodeScanner.stop();
                    console.log("Previous scanner instance stopped.");
                } catch (err) {
                    console.warn("Error stopping previous scanner instance (might not have been running):", err);
                }
                html5QrcodeScanner = null; // Clear the instance
                isScanning = false;
            }

            // Clear previous results/messages and update status
            document.getElementById('result').innerText = '';
            document.getElementById('cameraStatus').innerText = 'Initializing camera...';
            document.getElementById('flipCameraButton').disabled = true; // Disable during initialization

            try {
                // Get all available cameras
                // Ensure Html5Qrcode is available before calling getCameras()
                if (typeof window.Html5Qrcode === 'undefined') {
                    throw new Error("Html5Qrcode library not loaded or initialized.");
                }
                availableCameras = await window.Html5Qrcode.getCameras();

                if (availableCameras.length === 0) {
                    document.getElementById('cameraStatus').innerText = 'No cameras found on this device.';
                    document.getElementById('flipCameraButton').style.display = 'none'; // Hide button
                    return;
                }

                let targetCameraId = preferredCameraId;

                // If no specific camera ID is preferred (initial load or flip button not used)
                if (!targetCameraId) {
                    // Try to find the back camera first
                    const backCamera = availableCameras.find(camera =>
                        camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('environment')
                    );
                    // Then try to find the front camera
                    const frontCamera = availableCameras.find(camera =>
                        camera.label.toLowerCase().includes('front') || camera.label.toLowerCase().includes('user')
                    );

                    if (backCamera) {
                        targetCameraId = backCamera.id;
                    } else if (frontCamera) {
                        targetCameraId = frontCamera.id;
                    } else {
                        // Fallback to the first camera in the list if no clear back/front is identified
                        targetCameraId = availableCameras[0].id;
                    }
                } else {
                    // If a specific ID was passed (e.g., from flip button), ensure it's still valid
                    if (!availableCameras.some(camera => camera.id === targetCameraId)) {
                        console.warn(`Preferred camera ID ${targetCameraId} not found. Falling back to first available.`);
                        targetCameraId = availableCameras[0].id;
                    }
                }

                currentCameraId = targetCameraId; // Store the ID of the camera we are about to use

                // Initialize the scanner with the chosen camera ID
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader", {
                        fps: 10, // Frames per second for scanning
                        qrbox: { width: 250, height: 250 }, // Size of the QR code scanning box
                        disableFlip: false, // Explicitly allow camera flip if the library supports it directly
                        cameraId: currentCameraId // Use the specific camera ID
                    },
                    /* verbose= */ false // Set to true for more detailed console logs from the library
                );

                // Render the scanner
                await html5QrcodeScanner.render(onScanSuccess, onScanError);
                isScanning = true; // Set scanning flag to true

                // Update status message with the active camera's label
                const activeCameraLabel = availableCameras.find(c => c.id === currentCameraId)?.label || 'Unknown Camera';
                document.getElementById('cameraStatus').innerText = `Scanning with: ${activeCameraLabel}`;

                // Show/hide flip button based on camera count
                document.getElementById('flipCameraButton').style.display = availableCameras.length > 1 ? 'block' : 'none';
                document.getElementById('flipCameraButton').disabled = false; // Re-enable button
                console.log(`Scanner started with camera: ${activeCameraLabel} (ID: ${currentCameraId})`);

            } catch (err) {
                document.getElementById('cameraStatus').innerText = `Error accessing camera: ${err.message}. Please ensure camera permissions are granted.`;
                document.getElementById('flipCameraButton').style.display = 'none'; // Hide button on error
                document.getElementById('flipCameraButton').disabled = true;
                console.error("Camera initialization failed:", err);
            }
        }

        // Event listener for the "Flip Camera" button
        document.getElementById('flipCameraButton').addEventListener('click', async () => {
            if (availableCameras.length <= 1) {
                document.getElementById('cameraStatus').innerText = 'Only one camera available. Cannot flip.';
                document.getElementById('flipCameraButton').disabled = true;
                return;
            }

            // Find the index of the current camera
            const currentIndex = availableCameras.findIndex(camera => camera.id === currentCameraId);
            // Calculate the index of the next camera (loop back to start if at end)
            const nextIndex = (currentIndex + 1) % availableCameras.length;
            const nextCameraId = availableCameras[nextIndex].id;

            console.log(`Attempting to flip from ${currentCameraId} to ${nextCameraId}`);
            await startScanner(nextCameraId); // Restart scanner with the next camera
        });

        // Start the scanner when the window loads
        window.onload = () => {
            // Add a small delay to ensure the html5-qrcode library is fully loaded
            setTimeout(() => {
                startScanner(); // This will prioritize the back camera by default
            }, 500); // Increased delay to 500ms for robustness
        };
    </script>
</body>
</html>
