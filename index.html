<!DOCTYPE html>
<html>
<head>
  <title>QR Code Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.firebasestorage.app",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Helper: Hash input using SHA-256
    async function hashData(data) {
      const encoder = new TextEncoder();
      const buffer = encoder.encode(data);
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Main function: Generate QR and update Firestore
    async function generateQR() {
      const input = document.getElementById('inputText').value.trim();
      if (!input) {
        alert("Please enter a value.");
        return;
      }

      try {
        const hash = await hashData(input);

        // Generate QR
        const canvas = document.getElementById('qrCanvas');
        QRCode.toCanvas(canvas, hash, error => {
          if (error) console.error("QR generation failed:", error);
        });

        // Save to Firestore
        await setDoc(doc(collection(db, "valid_tokens"), hash), {
          createdAt: new Date().toISOString(),
          used: false
        });

        alert("QR code generated and saved to Firestore!");
      } catch (err) {
        console.error("Error:", err);
        alert("Something went wrong. See console.");
      }
    }

    // Expose to global scope
    window.generateQR = generateQR;
  </script>
</head>
<body>
  <h2>QR Code Generator</h2>
  <input type="text" id="inputText" placeholder="Enter email, ID, etc." />
  <button onclick="generateQR()">Generate QR</button>
  <br><br>
  <canvas id="qrCanvas"></canvas>
</body>
</html>
