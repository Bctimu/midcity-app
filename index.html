<!DOCTYPE html>
<html>
<head>
  <title>QR Code Token Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      text-align: center;
    }
    #qr-code {
      margin: 20px auto;
      width: 250px;
      height: 250px;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 1rem;
    }
    #generateResult {
      font-size: 1.2rem;
      margin-top: 20px;
    }
    #timer {
      font-size: 1.5rem;
      margin-top: 15px;
      color: #d9534f;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>QR Code Token Generator</h1>
  <button id="generateBtn">Generate QR Code Token (Expires in 1 Minute)</button>
  <canvas id="qr-code"></canvas>
  <div id="generateResult"></div>
  <div id="timer"></div>

  <script>
    // Firebase config - REPLACE with your own
    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // FingerprintJS - get visitorId
    async function getDeviceFingerprint() {
      const fp = await FingerprintJS.load();
      const result = await fp.get();
      return result.visitorId;
    }

    // Timer variables
    let countdownInterval;

    function startCountdown(expiresAt) {
      clearInterval(countdownInterval);
      const timerDiv = document.getElementById('timer');

      function updateTimer() {
        const now = new Date();
        const diff = expiresAt - now;
        if (diff <= 0) {
          timerDiv.innerText = "⏰ Token expired";
          clearInterval(countdownInterval);
          return;
        }
        const secondsLeft = Math.floor(diff / 1000);
        timerDiv.innerText = `⏳ Expires in ${secondsLeft} second${secondsLeft !== 1 ? 's' : ''}`;
      }

      updateTimer();
      countdownInterval = setInterval(updateTimer, 1000);
    }

    document.getElementById('generateBtn').addEventListener('click', async () => {
      const uid = 'user123'; // example user id
      const fingerprint = await getDeviceFingerprint();

      const createdAt = new Date();
      const expiresAt = new Date(createdAt.getTime() + 60 * 1000); // 1 minute later

      const hash = btoa(createdAt.getTime() + fingerprint).replace(/=/g, '');

      const tokenData = {
        uid,
        fingerprint,
        createdAt: createdAt.toISOString(),
        expiresAt: expiresAt.toISOString(),
        hash,
        timestamp: firebase.firestore.Timestamp.fromDate(createdAt)
      };

      try {
        await db.collection("valid_tokens").doc(hash).set(tokenData);

        const jsonString = JSON.stringify(tokenData);
        QRCode.toCanvas(document.getElementById('qr-code'), jsonString, { width: 250 });

        document.getElementById('generateResult').innerText = `QR Code generated. Expires at: ${expiresAt.toLocaleTimeString()}`;
        startCountdown(expiresAt);
      } catch (err) {
        console.error('Error saving token:', err);
        document.getElementById('generateResult').innerText = 'Error generating QR code.';
        document.getElementById('timer').innerText = '';
      }
    });
  </script>
</body>
</html>
