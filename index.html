<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Resident QR Code Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tokensRef = collection(db, "residentTokens");

    async function sha256(str) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(x => x.toString(16).padStart(2, "0")).join("");
    }

    async function generateQRCode(uid) {
      const timestamp = Date.now().toString();
      const rawToken = uid + "-" + timestamp;
      const hash = await sha256(rawToken);

      await addDoc(tokensRef, {
        uid,
        hash,
        timestamp: serverTimestamp()
      });

      const url = `https://yourdomain.com/scan.html?token=${hash}`;
      QRCode.toCanvas(document.getElementById("canvas"), url, { width: 256 });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const uid = params.get("uid");
      if (!uid) {
        document.getElementById("message").textContent = "Missing UID";
        return;
      }

      await generateQRCode(uid);

      document.getElementById("regen").addEventListener("click", async () => {
        document.getElementById("canvas").getContext("2d").clearRect(0, 0, 256, 256);
        await generateQRCode(uid);
      });
    });
  </script>
</head>
<body>
  <h1>Resident QR Code</h1>
  <canvas id="canvas"></canvas>
  <br>
  <button id="regen">Regenerate QR Code</button>
  <p id="message"></p>
</body>
</html>
