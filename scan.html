<!DOCTYPE html>
<html>
<head>
  <title>QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Use Tailwind CSS for a clean, mobile-first design -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Modular Firebase SDKs -->
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: auto; }
    #result { margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen relative">
  <h1 class="text-3xl font-bold mb-4 text-gray-800">Business QR Scanner</h1>
  <div id="reader" class="bg-white p-4 rounded-lg shadow-md"></div>
  <div id="result" class="mt-4 text-gray-700">Please wait, checking user status...</div>
  
  <!-- New Switch Camera Button -->
  <button id="camera-btn" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 hidden">
    Switch Camera
  </button>

  <!-- Logout Button -->
  <button id="logout-btn" class="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 hidden">
    Log Out
  </button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const reader = new Html5Qrcode("reader");
    const logoutBtn = document.getElementById('logout-btn');
    const resultDiv = document.getElementById('result');
    const cameraBtn = document.getElementById('camera-btn');
    let isAuthChecked = false;
    let cameras = [];
    let currentCameraIndex = 0;
    
    // Flag to check if scanner is initialized
    let isScannerStarted = false;


    // Authentication state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in. Proceed with scanner logic.
        const uid = user.uid;
        logoutBtn.classList.remove('hidden');

        if (!isScannerStarted) {
            resultDiv.textContent = "Please grant camera permissions to start the scanner.";
            try {
              cameras = await Html5Qrcode.getCameras();
              if (cameras.length > 1) {
                cameraBtn.classList.remove('hidden');
                cameraBtn.textContent = `Switch to Camera ${currentCameraIndex + 2}`;
              }
              if (cameras.length) {
                const cameraId = cameras[currentCameraIndex].id;
                reader.start(cameraId, { fps: 10, qrbox: 250 }, (decodedText) => onScanSuccess(decodedText, uid));
                isScannerStarted = true;
              } else {
                console.error("No cameras found.");
                resultDiv.textContent = "Error: No cameras found.";
              }
            } catch (err) {
                console.error(err);
                resultDiv.textContent = "Error: Could not access camera. Please make sure you grant camera permissions and try again.";
            }
        }
      } else {
        // Only redirect if the initial check is complete and no user is found.
        if (isAuthChecked) {
          resultDiv.textContent = "Please log in to use the scanner.";
          logoutBtn.classList.add('hidden');
          if (reader.isScanning) {
              reader.stop();
          }
          window.location.href = window.location.origin + "/login.html";
        }
      }
      isAuthChecked = true;
    });

    // Function to handle successful QR code scans
    async function onScanSuccess(decodedText, uid) {
      resultDiv.textContent = "Checking QR code...";
      reader.pause();
      
      if (!uid) {
          resultDiv.textContent = "Authentication error. Please log out and log back in.";
          reader.resume();
          return;
      }
      
      const docRef = doc(db, "valid_tokens", decodedText);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        resultDiv.textContent = "Invalid token.";
        reader.resume();
        return;
      }

      const data = docSnap.data();
      const now = new Date();

      if (data.expiresAt.toDate() < now) {
        resultDiv.textContent = "Token expired.";
        reader.resume();
        return;
      }

      const scansCollection = collection(db, "scans");
      try {
        await addDoc(scansCollection, {
          token: decodedText,
          scannedAt: Timestamp.now(),
          scannedBy: uid,
          originalUserId: data.userId,
          createdAt: data.createdAt,
        });
        resultDiv.textContent = "Scan logged!";
        setTimeout(() => reader.resume(), 1500);
      } catch (err) {
        resultDiv.textContent = "Error logging scan. Please check your Firestore security rules.";
        console.error(err);
        reader.resume();
      }
    }

    // Switch camera button event listener
    cameraBtn.addEventListener('click', async () => {
        if (reader.isScanning) {
            await reader.stop();
        }
        currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
        const newCameraId = cameras[currentCameraIndex].id;
        const newCameraText = `Switch to Camera ${(currentCameraIndex + 2) > cameras.length ? 1 : currentCameraIndex + 2}`;
        cameraBtn.textContent = newCameraText;
        await reader.start(newCameraId, { fps: 10, qrbox: 250 }, (decodedText) => onScanSuccess(decodedText, auth.currentUser.uid));
    });

    // Logout button event listener
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        // The onAuthStateChanged listener will handle the redirect.
      } catch (error) {
        console.error("Error signing out: ", error);
      }
    });
  </script>
</body>
</html>
