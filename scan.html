<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner with Fingerprint Verification</title>
  <style>
    #reader {
      width: 100%;
      max-width: 500px;
      margin: auto;
      padding-top: 40px;
    }
    #result {
      font-size: 1.2rem;
      text-align: center;
      margin-top: 20px;
      min-height: 2em;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center;">Scan Resident QR</h1>
  <div id="reader"></div>
  <div id="result"></div>

  <!-- Firebase compat scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- html5-qrcode UMD -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

  <!-- FingerprintJS UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Initialize FingerprintJS agent (returns Promise)
    const fpPromise = FingerprintJS.load();

    // Get device fingerprint
    async function getDeviceFingerprint() {
      const fp = await fpPromise;
      const result = await fp.get();
      return result.visitorId;
    }

    // Validate structure of Firestore token data
    function isValidTokenStructure(data) {
      return (
        data &&
        typeof data.uid === "string" &&
        typeof data.hash === "string" &&
        typeof data.fingerprint === "string" &&
        typeof data.createdAt === "string" &&
        typeof data.expiresAt === "string"
      );
    }

    // Initialize html5-qrcode scanner
    const scanner = new Html5Qrcode("reader");
    let scanning = false;

    async function startScanner() {
      if (scanning) return;
      scanning = true;

      try {
        await scanner.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          async (decodedText, decodedResult) => {
            // Stop scanning while verifying
            await scanner.stop();
            scanning = false;
            showResult("Verifying...");

            try {
              const parsed = JSON.parse(decodedText);

              // Check for expected keys before querying Firestore
              if (!parsed.hash) {
                showResult("❌ QR code missing required data.");
                restartScanner();
                return;
              }

              const docRef = db.collection("valid_tokens").doc(parsed.hash);
              const docSnap = await docRef.get();

              if (!docSnap.exists) {
                showResult("❌ Invalid or unknown QR code.");
                restartScanner();
                return;
              }

              const data = docSnap.data();

              if (!isValidTokenStructure(data)) {
                showResult("❌ Malformed token data.");
                restartScanner();
                return;
              }

              const currentFingerprint = await getDeviceFingerprint();

              if (currentFingerprint !== data.fingerprint) {
                showResult("❌ This QR was not generated for this device.");
                restartScanner();
                return;
              }

              const now = new Date();
              const expires = new Date(data.expiresAt);

              if (now > expires) {
                showResult("❌ QR code has expired.");
                restartScanner();
                return;
              }

              showResult("✅ QR code is valid!");

              // Optionally restart scanning after success if needed
              setTimeout(() => {
                showResult("");
                startScanner();
              }, 4000);

            } catch (err) {
              console.error("Verification error:", err);
              showResult("❌ Error verifying QR code.");
              restartScanner();
            }
          },
          (errorMessage) => {
            // Optional: handle scan failure per frame
            // console.warn("Scan error:", errorMessage);
          }
        );
      } catch (err) {
        console.error("Scanner start failed:", err);
        showResult("⚠️ Scanner failed to start.");
      }
    }

    // Show message in result div
    function showResult(message) {
      document.getElementById("result").innerText = message;
    }

    // Restart scanner after delay
    function restartScanner() {
      setTimeout(() => {
        showResult("");
        startScanner();
      }, 5000);
    }

    // Start scanning on window load
    window.onload = () => {
      startScanner();
    };
  </script>
</body>
</html>
