<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Code Scanner</title>

  <!-- Scanner + FingerprintJS + Firebase -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://openfpcdn.io/fingerprintjs/v4"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let scanner = null;
    let deviceFingerprint = null;

    async function getDeviceFingerprint() {
      const fp = await FingerprintJS.load();
      const result = await fp.get();
      return result.visitorId;
    }

    async function validateToken(scannedToken) {
      const tokensRef = collection(db, "residentTokens");
      const q = query(tokensRef, where("hash", "==", scannedToken));

      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        return { valid: false, reason: "QR code not found in database" };
      }

      const doc = querySnapshot.docs[0];
      const data = doc.data();

      // Validate required fields
      const requiredFields = [
        "uid", "fingerprint", "hash", "createdAt", "expiresAt", "timestamp"
      ];
      for (const field of requiredFields) {
        if (!(field in data) || data[field] === null || data[field] === undefined) {
          return { valid: false, reason: `Missing or empty field: ${field}` };
        }
      }

      // Validate expiration
      const now = new Date();
      const expiresAt = new Date(data.expiresAt);
      if (now > expiresAt) {
        return { valid: false, reason: "QR code has expired" };
      }

      // Validate fingerprint
      if (data.fingerprint !== deviceFingerprint) {
        return { valid: false, reason: "This QR code was not created for this device" };
      }

      return { valid: true, data };
    }

    function showResult(msg, isValid) {
      const resultEl = document.getElementById("result");
      resultEl.innerHTML = msg;
      resultEl.style.color = isValid ? "green" : "red";
    }

    async function handleScan(decodedText) {
      if (decodedText.includes("token=")) {
        const token = new URL(decodedText).searchParams.get("token");
        if (!token) {
          showResult("Invalid QR code format", false);
          return;
        }

        scanner.pause();
        const validation = await validateToken(token);

        if (validation.valid) {
          showResult(`✅ Valid Token! UID: ${validation.data.uid}`, true);
        } else {
          showResult(`❌ Invalid: ${validation.reason}`, false);
          setTimeout(() => scanner.resume(), 5000);
        }
      } else {
        showResult("❌ Unrecognized QR Code Format", false);
        scanner.pause();
        setTimeout(() => scanner.resume(), 5000);
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      // Get fingerprint first
      deviceFingerprint = await getDeviceFingerprint();

      scanner = new Html5Qrcode("scanner");
      scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        handleScan,
        error => {}
      );
    });
  </script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    #scanner {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
    }
    #result {
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Scan Resident QR Code</h1>
  <div id="scanner"></div>
  <div id="result">Awaiting scan...</div>
</body>
</html>
