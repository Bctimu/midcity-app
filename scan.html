<!DOCTYPE html>
<html>
<head>
  <title>QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <style>
    #reader {
      width: 100%;
      max-width: 500px;
      margin: auto;
      padding-top: 40px;
    }
    #result {
      font-size: 1.2rem;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center;">Scan Resident QR</h1>
  <div id="reader"></div>
  <div id="result"></div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Get device fingerprint
    async function getDeviceFingerprint() {
      const fpPromise = FingerprintJS.load();
      const fp = await fpPromise;
      const result = await fp.get();
      return result.visitorId;
    }

    // Validate structure of token
    function isValidTokenStructure(data) {
      return (
        typeof data.uid === "string" &&
        typeof data.hash === "string" &&
        typeof data.fingerprint === "string" &&
        typeof data.createdAt === "string" &&
        typeof data.expiresAt === "string" &&
        data.timestamp?.seconds !== undefined
      );
    }

    // Initialize scanner
    const scanner = new Html5Qrcode("reader");
    let scanning = false;

    async function startScanner() {
      if (scanning) return;
      scanning = true;

      try {
        await scanner.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          },
          async (decodedText, decodedResult) => {
            scanner.stop();
            scanning = false;
            document.getElementById("result").innerText = "Verifying...";

            try {
              const parsed = JSON.parse(decodedText);
              const docRef = db.collection("valid_tokens").doc(parsed.hash);
              const docSnap = await docRef.get();

              if (!docSnap.exists) {
                return showResult("❌ Invalid or unknown QR code");
              }

              const data = docSnap.data();

              // Validate structure
              if (!isValidTokenStructure(data)) {
                return showResult("❌ Malformed token data.");
              }

              // Fingerprint match
              const currentFingerprint = await getDeviceFingerprint();
              if (currentFingerprint !== data.fingerprint) {
                return showResult("❌ This QR was not generated for this device.");
              }

              // Expiration check
              const now = new Date();
              const expires = new Date(data.expiresAt);
              if (now > expires) {
                return showResult("❌ QR code has expired.");
              }

              showResult("✅ QR code is valid!");
            } catch (error) {
              console.error(error);
              showResult("❌ Error verifying QR code.");
            }
          },
          (errorMessage) => {
            console.warn(errorMessage);
          }
        );
      } catch (err) {
        console.error("Scanner start failed:", err);
        document.getElementById("result").innerText = "⚠️ Scanner failed to start.";
      }
    }

    // Show result & optionally restart
    function showResult(message) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerText = message;

      // Restart scanner after 5 seconds if invalid
      if (!message.startsWith("✅")) {
        setTimeout(() => {
          resultDiv.innerText = "";
          startScanner();
        }, 5000);
      }
    }

    // Start scanning on load
    window.onload = () => {
      startScanner();
    };
  </script>
</body>
</html>
