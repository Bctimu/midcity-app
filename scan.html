<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business QR Scanner</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #374151; /* text-gray-800 */
        }
        #reader {
            width: 100%;
            max-width: 300px; /* Adjusted for better mobile view */
            height: auto;
            margin: 0 auto 1.5rem auto; /* mb-6 */
            border: 2px solid #d1d5db; /* border-2 border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden;
        }
        /* Custom modal overlay styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
        <h1 class="text-3xl font-bold mb-4 text-blue-700">Business QR Scanner</h1>
        <p class="text-sm text-gray-600 mb-4">Merchant ID (from URL): <span id="merchant-id" class="font-semibold text-blue-600">N/A</span></p>
        <p class="text-sm text-gray-600 mb-6">Your User ID: <span id="current-user-id" class="font-semibold text-blue-600 break-all">Not authenticated</span></p>

        <div id="reader"></div>

        <p id="camera-status" class="text-md font-semibold text-gray-700 mb-4">Initializing camera...</p>
        <div id="scan-result" class="bg-blue-50 p-3 rounded-lg text-blue-800 font-medium break-words">
            Waiting for scan...
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-overlay">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100">
            <h2 id="modal-title" class="text-xl font-bold mb-3"></h2>
            <p id="modal-message" class="text-gray-700 mb-5"></p>
            <button id="modal-ok-button" class="w-full py-2 px-4 rounded-lg font-semibold transition duration-200 ease-in-out bg-blue-500 hover:bg-blue-600 text-white">
                OK
            </button>
        </div>
    </div>

    <script>
        // Global variables from Canvas environment (mocked for direct HTML execution)
        // Access global variables directly from the window object to avoid ReferenceError
        const appId = window.__app_id || 'default-app-id';
        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : JSON.parse(JSON.stringify({
            apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
            authDomain: "admin-17c3d.firebaseapp.com",
            projectId: "admin-17c3d",
            storageBucket: "admin-17c3d.appspot.com",
            messagingSenderId: "456331474186",
            appId: "1:456331474186:web:0385a740d37862f82af6f3",
            measurementId: "G-DTP30VXLN7"
        }));
        const initialAuthToken = window.__initial_auth_token || null;

        // DOM Elements
        const merchantIdEl = document.getElementById('merchant-id');
        const currentUserIdEl = document.getElementById('current-user-id');
        const cameraStatusEl = document.getElementById('camera-status');
        const scanResultEl = document.getElementById('scan-result');
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkButton = document.getElementById('modal-ok-button');

        let db;
        let auth;
        let html5QrCodeScanner;
        let currentUserId = 'Not authenticated'; // Default before auth

        // Get merchantId from URL parameters
        const merchantId = new URLSearchParams(window.location.search).get("uid");
        if (merchantId) {
            merchantIdEl.textContent = merchantId;
        }

        // Function to show custom modal
        function showCustomModal(title, message, type) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            // Update button/title color based on type
            modalTitle.className = `text-xl font-bold mb-3 ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600'}`;
            modalOkButton.className = `w-full py-2 px-4 rounded-lg font-semibold transition duration-200 ease-in-out ${type === 'success' ? 'bg-green-500 hover:bg-green-600 text-white' : type === 'error' ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`;
            customModal.classList.remove('hidden');
            customModal.classList.add('flex');
        }

        // Function to close custom modal
        function closeCustomModal() {
            customModal.classList.remove('flex');
            customModal.classList.add('hidden');
        }

        // Event listener for modal OK button
        modalOkButton.addEventListener('click', closeCustomModal);

        // Initialize Firebase and Authentication
        async function initializeFirebase() {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();

                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        currentUserIdEl.textContent = user.uid;
                        console.log("Firebase authenticated with UID:", user.uid);
                        // Start scanner only after auth is ready
                        startQrScanner();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await auth.signInWithCustomToken(initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await auth.signInAnonymously();
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            cameraStatusEl.textContent = "Error: Authentication failed.";
                            showCustomModal('Error', `Authentication failed: ${error.message}`, 'error');
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                cameraStatusEl.textContent = "Error: Firebase initialization failed.";
                showCustomModal('Error', `Firebase initialization failed: ${error.message}`, 'error');
            }
        }

        // Function to start the QR scanner
        async function startQrScanner() {
            const qrCodeRegionId = "reader";
            cameraStatusEl.textContent = "Requesting camera access...";

            // Ensure Html5Qrcode is available globally
            if (typeof Html5Qrcode === 'undefined') {
                console.error("Html5Qrcode is not loaded. Please ensure the script tag is present and loaded.");
                cameraStatusEl.textContent = "Error: QR library not loaded.";
                showCustomModal('Error', 'QR code library not loaded. Please try refreshing.', 'error');
                return;
            }

            // Initialize Html5Qrcode instance
            if (!html5QrCodeScanner) {
                html5QrCodeScanner = new Html5Qrcode(qrCodeRegionId);
            }

            try {
                // Attempt to start with facingMode 'environment' (back camera)
                await html5QrCodeScanner.start({ facingMode: { exact: "environment" } }, { fps: 10, qrbox: 250 }, onScanSuccess, onScanError);
                cameraStatusEl.textContent = "Scanning with back camera...";
            } catch (err) {
                console.warn("Could not start back camera with exact 'environment' facing mode. Trying other options...", err);
                cameraStatusEl.textContent = "Finding available cameras...";

                try {
                    const cameras = await Html5Qrcode.getCameras();
                    if (cameras && cameras.length) {
                        let selectedCameraId = null;
                        // Try to find a camera explicitly labeled as 'back' or 'environment'
                        const backCamera = cameras.find(camera =>
                            camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('environment')
                        );

                        if (backCamera) {
                            selectedCameraId = backCamera.id;
                            cameraStatusEl.textContent = "Scanning with identified back camera...";
                        } else if (cameras.length > 1) {
                            // If no explicit back camera, but more than one camera, try the second one
                            selectedCameraId = cameras[1].id;
                            cameraStatusEl.textContent = "Scanning with second camera (likely back)...";
                        } else {
                            // Fallback to the first camera if only one is available
                            selectedCameraId = cameras[0].id;
                            cameraStatusEl.textContent = "Scanning with default camera...";
                        }

                        if (selectedCameraId) {
                            await html5QrCodeScanner.start(selectedCameraId, { fps: 10, qrbox: 250 }, onScanSuccess, onScanError);
                        } else {
                            cameraStatusEl.textContent = "No suitable camera found.";
                            showCustomModal('Error', 'No suitable camera found for scanning.', 'error');
                        }
                    } else {
                        cameraStatusEl.textContent = "No cameras found on this device.";
                        showCustomModal('Error', 'No cameras found on this device.', 'error');
                    }
                } catch (cameraErr) {
                    console.error("Error accessing cameras:", cameraErr);
                    cameraStatusEl.textContent = "Error accessing camera.";
                    showCustomModal('Error', `Failed to access camera: ${cameraErr.message}`, 'error');
                }
            }
        }

        // Function to handle successful QR code scans
        async function onScanSuccess(decodedText) {
            scanResultEl.textContent = "Checking QR code...";
            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                html5QrCodeScanner.pause(); // Pause scanner to prevent multiple scans
            }

            try {
                // Reference to the public valid_tokens collection
                const validTokensRef = db.collection(`artifacts/${appId}/public/data/valid_tokens`);
                const docSnap = await validTokensRef.doc(decodedText).get();

                if (!docSnap.exists) {
                    scanResultEl.textContent = "Invalid token.";
                    showCustomModal('Invalid Token', 'The scanned QR code is not a valid token.', 'error');
                    html5QrCodeScanner.resume();
                    return;
                }

                const data = docSnap.data();
                const now = firebase.firestore.Timestamp.now();

                if (data.expiresAt && data.expiresAt.toDate() < now.toDate()) {
                    scanResultEl.textContent = "Token expired.";
                    showCustomModal('Token Expired', 'This QR code has expired.', 'error');
                    html5QrCodeScanner.resume();
                    return;
                }

                // Reference to the private qrScans collection for the current user
                const qrScansRef = db.collection(`artifacts/${appId}/users/${currentUserId}/qrScans`);
                await qrScansRef.add({
                    token: decodedText,
                    scannedAt: firebase.firestore.Timestamp.now(),
                    scannedBy: merchantId || currentUserId, // Fallback to currentUserId if merchantId is not set
                    originalUserId: data.userId, // The user who originally generated the token
                    createdAt: data.createdAt,
                });

                scanResultEl.textContent = "Scan logged successfully!";
                showCustomModal('Success', 'QR code verified and scan logged!', 'success');
                // Resume scanner after a short delay for user to read the message
                setTimeout(() => html5QrCodeScanner.resume(), 1500);
            } catch (err) {
                console.error("Error during scan processing or Firestore operation:", err);
                scanResultEl.textContent = "Error processing scan.";
                showCustomModal('Error', `An error occurred: ${err.message}`, 'error');
                if (html5QrCodeScanner) {
                    html5QrCodeScanner.resume();
                }
            }
        }

        // Function to handle errors during QR code scanning
        function onScanError(errorMessage) {
            // console.warn("QR Scan Error:", errorMessage); // Log errors for debugging, but don't show to user constantly
            // Avoid setting scanResult on every minor error, only on significant ones if needed
        }

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;

        // Cleanup function for when the page is unloaded (e.g., user navigates away)
        window.addEventListener('beforeunload', () => {
            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                html5QrCodeScanner.stop().catch(err => console.error("Error stopping scanner:", err));
            }
        });
    </script>
</body>
</html>
