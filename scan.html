<!DOCTYPE html>
<html>
<head>
  <title>QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Use Tailwind CSS for a clean, mobile-first design -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Modular Firebase SDKs -->
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: auto; }
    #result { margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen relative">
  <h1 class="text-3xl font-bold mb-4 text-gray-800">Business QR Scanner</h1>
  
  <div id="content-container" class="flex flex-col items-center hidden">
    <div id="reader" class="bg-white p-4 rounded-lg shadow-md"></div>
    <button id="camera-btn" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 hidden">
      Switch Camera
    </button>
  </div>

  <div id="auth-status" class="mt-4 text-gray-700">You must be logged in to use the scanner.</div>
  
  <button id="login-redirect-btn" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200">
    Go to Login
  </button>

  <!-- Logout Button -->
  <button id="logout-btn" class="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-colors duration-200 hidden">
    Log Out
  </button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const BASE_URL = "https://bctimu.github.io/midcity-app";

    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const reader = new Html5Qrcode("reader");
    const logoutBtn = document.getElementById('logout-btn');
    const authStatusDiv = document.getElementById('auth-status');
    const cameraBtn = document.getElementById('camera-btn');
    const loginRedirectBtn = document.getElementById('login-redirect-btn');
    const contentContainer = document.getElementById('content-container');
    let isAuthChecked = false;
    let cameras = [];
    let currentCameraIndex = 0;
    let isScannerStarted = false;

    const startScanner = (uid) => {
      authStatusDiv.textContent = "Please grant camera permissions to start the scanner.";
      try {
        Html5Qrcode.getCameras().then(availableCameras => {
          cameras = availableCameras;
          if (cameras.length > 1) {
            cameraBtn.classList.remove('hidden');
            cameraBtn.textContent = `Switch to Camera ${currentCameraIndex + 2}`;
          }

          if (cameras.length) {
            const cameraId = cameras[currentCameraIndex].id;
            reader.start(cameraId, { fps: 10, qrbox: 250 }, (decodedText) => onScanSuccess(decodedText, uid));
            isScannerStarted = true;
          } else {
            console.error("No cameras found.");
            authStatusDiv.textContent = "Error: No cameras found.";
          }
        }).catch(err => {
          console.error(err);
          authStatusDiv.textContent = "Error: Could not access camera. Please make sure you grant camera permissions and try again.";
        });
      } catch (err) {
        console.error("Error starting scanner: ", err);
        authStatusDiv.textContent = "An error occurred while starting the scanner.";
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const uid = user.uid;
        authStatusDiv.textContent = "Authentication successful. Starting scanner...";
        logoutBtn.classList.remove('hidden');
        loginRedirectBtn.classList.add('hidden');
        contentContainer.classList.remove('hidden');
        if (!isScannerStarted) {
          startScanner(uid);
        }
      } else {
        if (isAuthChecked) {
          authStatusDiv.textContent = "You must be logged in to use the scanner.";
          logoutBtn.classList.add('hidden');
          contentContainer.classList.add('hidden');
          loginRedirectBtn.classList.remove('hidden');
          if (reader.isScanning) {
            reader.stop().catch(err => console.error("Error stopping scanner: ", err));
          }
        }
      }
      isAuthChecked = true;
    });

    loginRedirectBtn.addEventListener('click', () => {
      window.location.href = BASE_URL + "/login.html";
    });

    async function onScanSuccess(decodedText, uid) {
      authStatusDiv.textContent = "Checking QR code...";
      reader.pause();
      
      if (!uid) {
        authStatusDiv.textContent = "Authentication error. Please log out and log back in.";
        reader.resume();
        return;
      }
      
      const docRef = doc(db, "valid_tokens", decodedText);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        authStatusDiv.textContent = "Invalid token.";
        reader.resume();
        return;
      }

      const data = docSnap.data();
      const now = new Date();

      if (data.expiresAt.toDate() < now) {
        authStatusDiv.textContent = "Token expired.";
        reader.resume();
        return;
      }

      const scansCollection = collection(db, "scans");
      try {
        await addDoc(scansCollection, {
          token: decodedText,
          scannedAt: Timestamp.now(),
          scannedBy: uid,
          originalUserId: data.userId,
          createdAt: data.createdAt,
        });
        authStatusDiv.textContent = "Scan logged!";
        setTimeout(() => reader.resume(), 1500);
      } catch (err) {
        authStatusDiv.textContent = "Error logging scan. Please check your Firestore security rules.";
        console.error(err);
        reader.resume();
      }
    }

    cameraBtn.addEventListener('click', async () => {
      if (reader.isScanning) {
        await reader.stop();
      }
      currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
      const newCameraId = cameras[currentCameraIndex].id;
      const newCameraText = `Switch to Camera ${(currentCameraIndex + 2) > cameras.length ? 1 : currentCameraIndex + 2}`;
      cameraBtn.textContent = newCameraText;
      await reader.start(newCameraId, { fps: 10, qrbox: 250 }, (decodedText) => onScanSuccess(decodedText, auth.currentUser.uid));
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("Error signing out: ", error);
      }
    });
  </script>
</body>
</html>
