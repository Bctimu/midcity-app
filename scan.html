<!DOCTYPE html>
<html>
<head>
  <title>QR Code Scanner</title>
  <style>
    video, canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h2>QR Code Scanner</h2>
  <video id="video" muted playsinline></video>
  <div id="status">Waiting for QR code...</div>

  <script type="module">
    import QrScanner from "./qr-scanner.min.js"; // Ensure this file is in the same folder
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // Firebase config (same as index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.firebasestorage.app",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');

    // Hash function (SHA-256)
    async function hashData(data) {
      const encoder = new TextEncoder();
      const buffer = encoder.encode(data);
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Check Firestore if token exists and is valid
    async function checkToken(hash) {
      const docRef = doc(db, "valid_tokens", hash);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (!data.used) {
          // Mark token as used
          await updateDoc(docRef, { used: true, usedAt: new Date().toISOString() });
          return true; // valid and not used
        } else {
          return false; // already used
        }
      }
      return false; // does not exist
    }

    // Setup QrScanner
    const scanner = new QrScanner(video, async (result) => {
      statusEl.textContent = "QR Code detected, verifying...";
      try {
        const hash = await hashData(result.data);
        const valid = await checkToken(hash);
        if (valid) {
          statusEl.textContent = "✅ Valid QR Code! Access granted.";
          statusEl.style.color = "green";
        } else {
          statusEl.textContent = "❌ Invalid or already used QR Code!";
          statusEl.style.color = "red";
        }
      } catch (error) {
        statusEl.textContent = "⚠️ Error verifying QR code.";
        statusEl.style.color = "orange";
        console.error(error);
      }
    });

    // Start scanning on page load
    scanner.start();

  </script>
</body>
</html>
