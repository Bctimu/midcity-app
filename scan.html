<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    #result {
      font-size: 1.5rem;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Scan Resident QR</h1>
  <div id="reader" style="width:300px;"></div>
  <div id="result">Waiting for scan...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, query, where, getDocs, limit
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tokensRef = collection(db, "residentTokens");

    const resultElem = document.getElementById("result");
    const scanner = new Html5Qrcode("reader");

    async function handleScan(result) {
      scanner.pause();
      resultElem.textContent = "QR code scanned. Verifying...";

      try {
        const url = new URL(result);
        const scannedToken = url.searchParams.get("token");

        if (!scannedToken) {
          resultElem.textContent = "Invalid QR format. No token found.";
          restartScanner();
          return;
        }

        const q = query(tokensRef, where("hash", "==", scannedToken), limit(1));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          resultElem.textContent = "✅ Verified resident QR!";
        } else {
          resultElem.textContent = "❌ Invalid or unknown QR code.";
          restartScanner();
        }
      } catch (err) {
        resultElem.textContent = "❌ Error reading QR.";
        console.error(err);
        restartScanner();
      }
    }

    function restartScanner() {
      setTimeout(() => {
        resultElem.textContent = "Waiting for scan...";
        scanner.resume();
      }, 5000);
    }

    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      handleScan
    );
  </script>
</body>
</html>
