
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Code Scanner</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCP_EHp-NdHnwyOZ49_OOEiqLUBV2irgeg",
      authDomain: "admin-17c3d.firebaseapp.com",
      projectId: "admin-17c3d",
      storageBucket: "admin-17c3d.appspot.com",
      messagingSenderId: "456331474186",
      appId: "1:456331474186:web:0385a740d37862f82af6f3",
      measurementId: "G-DTP30VXLN7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function generateFingerprint() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = "14px 'Arial'";
      ctx.textBaseline = "alphabetic";
      ctx.fillStyle = "#f60";
      ctx.fillRect(125, 1, 62, 20);
      ctx.fillStyle = "#069";
      ctx.fillText("fingerprint", 2, 15);
      ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
      ctx.fillText("fingerprint", 4, 17);

      const dataUrl = canvas.toDataURL();
      const hashBuffer = new TextEncoder().encode(dataUrl);
      return crypto.subtle.digest("SHA-256", hashBuffer).then(hash => {
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
      });
    }

    async function verifyToken(scannedHash) {
      const tokenRef = doc(db, "valid_tokens", scannedHash);
      const docSnap = await getDoc(tokenRef);

      if (!docSnap.exists()) {
        alert("Invalid or unknown QR code.");
        return;
      }

      const tokenData = docSnap.data();
      const now = new Date();
      const expires = new Date(tokenData.expiresAt);

      if (now > expires) {
        alert("QR code has expired.");
        return;
      }

      const localFingerprint = await generateFingerprint();
      if (tokenData.fingerprint !== localFingerprint) {
        alert("This QR code was not generated on this device.");
        return;
      }

      alert("QR code is valid and matches fingerprint!");
    }

    window.onload = async () => {
      const videoElem = document.getElementById("preview");

      const qrScanner = new QrScanner(videoElem, async (result) => {
        qrScanner.stop();
        await verifyToken(result);
      });

      await qrScanner.start();
    };
  </script>
  <script src="qr-scanner.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    video { width: 80%; margin-top: 20px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Scan QR Code</h1>
  <video id="preview"></video>
</body>
</html>
